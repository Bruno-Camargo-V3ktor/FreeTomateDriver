# Protocolo USB - Mesa Digitalizadora Tomate MTM-1106 | Gotop - [T501]

Este documento mapeia os pacotes USB (HID Reports) interceptados via engenharia reversa do modelo Tomate M110M. A mesa opera como um dispositivo composto, registrando-se no sistema com múltiplas interfaces (Teclado, Controle de Mídia e Digitizer/Caneta).

## 1. Inicialização (Magic Packet)
Por padrão ao ser conectada, a mesa inicia em "Modo Celular" (área de desenho restrita e comportamento simplificado). Para alternar para o "Modo Desktop" (alta resolução, mapeamento total da área e uso do Report ID `09`), é necessário enviar um pacote de inicialização via **USB Control Transfer**.

* **Setup Packet (SET_REPORT):**
  * **Payload de Ativação:** `02 02 b5 02 00 00 00 00`

---

## 2. Movimento e Pressão da Caneta (Report ID 09)
Após o envio do *Magic Packet*, a mesa passa a transmitir dados de alta resolução em pacotes de 10 bytes através do *Interrupt Endpoint*. Estes pacotes reportam a posição absoluta da caneta e a pressão exercida.

**Estrutura do Pacote:** `[09, ST, XL, XH, YL, YH, PL, PH, A1, A2]`

| Byte | Campo | Valores / Descrição |
| :--- | :--- | :--- |
| `0` | **Report ID** | Fixo em `09` (Modo Desktop). |
| `1` | **Status (Flags)** | `C0` (Caneta flutuando/Hover) <br> `C1` (Caneta pressionando a superfície) <br> `80` (Caneta fora de alcance/Longe). |
| `2` | **X (Low)** | Parte menos significativa do eixo X. |
| `3` | **X (High)** | Parte mais significativa do eixo X. *(Juntos com o Byte 2, formam um `uint16` em Little Endian).* |
| `4` | **Y (Low)** | Parte menos significativa do eixo Y. |
| `5` | **Y (High)** | Parte mais significativa do eixo Y. *(Juntos formam a posição vertical em `uint16`).* |
| `6` | **Pressão (Low)** | Parte menos significativa da pressão. |
| `7` | **Pressão (High)**| Parte mais significativa da pressão. *(Nota: Possui um ruído basal/offset de ~29 a 35 unidades).* |
| `8` | **Padding**| Preenchimento para fechar 10 bytes. |
| `9` | **Padding**| Preenchimento para fechar 10 bytes. |

---

## 3. Express Keys e Botões Físicos (Report ID 01)
Os botões da mesa e da caneta operam sob a classe "Keyboard" padrão do protocolo HID, enviando pacotes de 8 bytes. As teclas simultâneas são lidas através de **Bitmasks** (máscaras de bits).

**Estrutura do Pacote:** `[01, 80, FF, 00, B1, B2, 00, 00]` *(Nota: O byte 2 pode alternar entre `FF` e `00` dependendo do estado).*

### Sinal de Release (Fim de Input)
Sempre que uma tecla é solta, ou a caneta é levantada após o uso de botões superiores, a mesa envia o seguinte pacote de zeramento:
* **Release Packet:** `[01, 80, 00, 00, 00, 00, 00, 00]`

### Mapeamento de Bits (Bitmasks)

| Botão Físico / Ação | Byte Modificado | Valor (Hex) |
| :--- | :---: | :--- |
| `[ CTRL - ]` | **Byte 4 (`B1`)** | `80` |
| `[ '[' ]` | **Byte 4 (`B1`)** | `40` |
| `[ Mouse UP ]` | **Byte 4 (`B1`)** | `20` |
| `[ Mouse DOWN ]`| **Byte 4 (`B1`)** | `10` |
| `[ CTRL ]` | **Byte 4 (`B1`)** | `08` |
| `[ ALT ]` | **Byte 4 (`B1`)** | `04` |
| `[ SPACE ]` | **Byte 4 (`B1`)** | `02` |
| `[ TAB ]` | **Byte 4 (`B1`)** | `01` |
| | | |
| `[ Caneta Botão 1 ]`| **Byte 5 (`B2`)** | `20` |
| `[ Caneta Botão 2 ]`| **Byte 5 (`B2`)** | `10` |
| `[ ']' ]` | **Byte 5 (`B2`)** | `08` |
| `[ B ]` | **Byte 5 (`B2`)** | `04` |
| `[ E ]` | **Byte 5 (`B2`)** | `02` |
| `[ CTRL + ]` | **Byte 5 (`B2`)** | `01` |

---

## 4. Teclas de Controle de Mídia (Report ID 04)
Utiliza a Usage Page de "Consumer Control". Pacotes de 3 bytes.

* **Sinal de Release:** `04 00 00`

| Ação | Pacote Hexadecimal |
| :--- | :--- |
| **Mute** | `04 E2 00` |
| **Volume Down** | `04 EA 00` |
| **Volume Up** | `04 E9 00` |
| **Music** | `04 89 01` |
| **Pause / Resume**| `04 CD 00` |
| **Back** | `04 B6 00` |
| **Forward** | `04 B5 00` |
| **Home** | `04 23 02` |
| **Calculator** | `04 92 01` |

---

## 5. Teclas de Sistema (Report ID 02)
Pacotes de 8 bytes para comandos de nível de sistema (ex: tecla Windows).

| Ação | Pacote Hexadecimal |
| :--- | :--- |
| **Apertar SUPER** | `02 08 00 07 00 00 00 00` |
| **Soltar SUPER** | `02 08 00 00 00 00 00 00` |
